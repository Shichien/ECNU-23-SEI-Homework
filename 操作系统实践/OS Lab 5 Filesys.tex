% æ³¨æ„äº‹é¡¹ï¼šç¼–è¯‘ä¸¤æ¬¡ï¼Œä»¥ç¡®ä¿ç›®å½•ã€é¡µç å®Œæ•´æ˜¾ç¤º

\def\allfiles{}

\documentclass[14pt,a4paper,UTF8,twoside]{article}

% Formatting Packages â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
\usepackage{multicol}
\usepackage{multirow}
\usepackage{enumitem}
\usepackage{indentfirst}
\usepackage[toc]{multitoc}

% Math & Physics Packages â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
\usepackage{amsmath, amsthm, amsfonts, amssymb}
\usepackage{setspace}
\usepackage{physics}
\usepackage{cancel}
\usepackage{nicefrac}
\usepackage{unicode-math} % å…è®¸æ•°å­¦å…¬å¼ä½¿ç”¨ç‰¹å®šå­—ä½“

% Image-related Packages â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
\usepackage{float} % æµ®åŠ¨ä½“ç¯å¢ƒ
\usepackage{subcaption} % å­å›¾åŒ…
\usepackage{graphics, graphicx}
\usepackage{tikz, tikz-qtree}
\usepackage{mdframed}
\usepackage{lmodern}
\usetikzlibrary{arrows.meta}
\usetikzlibrary{shapes.geometric, arrows}
\tikzstyle{startstop} = [rectangle, rounded corners, minimum width=3cm, minimum height=1cm,text centered, draw=black, fill=red!30]
\tikzstyle{process} = [rectangle, minimum width=3cm, minimum height=1cm, text centered, draw=black, fill=blue!30]
\tikzstyle{arrow} = [thick,->,>=stealth]

\usepackage{pgfplots}
\pgfplotsset{compat=1.18}
\usepackage{xcolor}
\usepackage{fourier-orns}
\usepackage{lipsum}

% Colour Palette â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
\definecolor{merah}{HTML}{F4564E}
\definecolor{merahtua}{HTML}{89313E}
\definecolor{biru}{HTML}{60BBE5}
\definecolor{birutua}{HTML}{412F66}
\definecolor{hijau}{HTML}{59CC78}
\definecolor{hijautua}{HTML}{366D5B}
\definecolor{kuning}{HTML}{FFD56B}
\definecolor{jingga}{HTML}{FBA15F}
\definecolor{ungu}{HTML}{8C5FBF}
\definecolor{lavender}{HTML}{CBA5E8}
\definecolor{merjamb}{HTML}{FFB6E0}
\definecolor{mygray}{HTML}{E6E6E6}
\definecolor{mygreen}{rgb}{0,0.6,0}
\definecolor{mymauve}{rgb}{0.58,0,0.82}

% Theorems â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
\usepackage{tcolorbox}
\usepackage{changepage}
\tcbuselibrary{skins,breakable,theorems}

\newcounter{hitung}
\setcounter{hitung}{\thesection}

\makeatletter
	% Proof è¯æ˜å¦‚ä¸‹
	\def\tcb@theo@widetitle#1#2#3{\hbox to \textwidth{\textsc{\large#1}\normalsize\space#3\hfil(#2)}}
	\tcbset{
		theorem style/theorem wide name and number/.code={ \let\tcb@theo@title=\tcb@theo@widetitle},
		proofbox/.style={skin=enhancedmiddle,breakable,parbox=false,boxrule=0mm,
			check odd page, toggle left and right, colframe=black!20!white!92!hijau,
			leftrule=8pt, rightrule=0mm, boxsep=0mm,arc=0mm, outer arc=0mm,
			left=3mm,right=3mm,top=0mm,bottom=0mm, toptitle=0mm,
			bottomtitle=0mm,colback=gray!3!white!98!biru, before skip=8pt, after skip=8pt,
			before={\par\vskip-2pt},after={\par\smallbreak},
		},
	}
	\newtcolorbox{ProofBox}{proofbox}
	\makeatother
	
	\let\realproof\proof
	\let\realendproof\endproof
	\renewenvironment{proof}[1][Prove:]{\ProofBox\strut\textsc{#1}\space}{\endProofBox}
        \AtEndEnvironment{proof}{\null\hfill$\blacksquare$}
        % Definition å®šä¹‰ç¯å¢ƒ
	\newtcbtheorem[use counter=hitung, number within=section]{dfn}{å®šä¹‰}
	{theorem style=theorem wide name and number,breakable,enhanced,arc=3.5mm,outer arc=3.5mm,
		boxrule=0pt,toprule=1pt,leftrule=0pt,bottomrule=1pt, rightrule=0pt,left=0.2cm,right=0.2cm,
		titlerule=0.5em,toptitle=0.1cm,bottomtitle=-0.1cm,top=0.2cm,
		colframe=white!10!biru,
		colback=white!90!biru,
		coltitle=white,
		shadow={1.3mm}{-1.3mm}{0mm}{gray!50!white}, % æ·»åŠ é˜´å½±
        coltext=birutua!60!gray, title style={white!10!biru}, rbefoe skip=8pt, after skip=8pt,
		fonttitle=\bfseries,fontupper=\normalsize}{dfn}

	% ç­”é¢˜å¡
	\newtcbtheorem[use counter=hitung, number within=section]{ans}{è§£ç­”}
	{theorem style=theorem wide name and number,breakable,enhanced,arc=3.5mm,outer arc=3.5mm,
		boxrule=0pt,toprule=1pt,leftrule=0pt,bottomrule=1pt, rightrule=0pt,left=0.2cm,right=0.2cm,
		titlerule=0.5em,toptitle=0.1cm,bottomtitle=-0.1cm,top=0.2cm,
		colframe=white!10!biru,
		colback=white!90!biru,
		coltitle=white,
		shadow={1.3mm}{-1.3mm}{0mm}{gray!50!white}, % æ·»åŠ é˜´å½±
        coltext=birutua!60!gray, title style={white!10!biru}, before skip=8pt, after skip=8pt,
		fonttitle=\bfseries,fontupper=\normalsize}{ans}

	% Axiom
	\newtcbtheorem[use counter=hitung, number within=section]{axm}{å…¬ç†}
	{theorem style=theorem wide name and number,breakable,enhanced,arc=3.5mm,outer arc=3.5mm,
		boxrule=0pt,toprule=1pt,leftrule=0pt,bottomrule=1pt, rightrule=0pt,left=0.2cm,right=0.2cm,
		titlerule=0.5em,toptitle=0.1cm,bottomtitle=-0.1cm,top=0.2cm,
		colframe=white!10!biru,colback=white!90!biru,coltitle=white,
		shadow={1.3mm}{-1.3mm}{0mm}{gray!50!white!90}, % æ·»åŠ é˜´å½±
        coltext=birutua!60!gray,title style={white!10!biru},before skip=8pt, after skip=8pt,
		fonttitle=\bfseries,fontupper=\normalsize}{axm}
 
	% Theorem
	\newtcbtheorem[use counter=hitung, number within=section]{thm}{å®šç†}
	{theorem style=theorem wide name and number,breakable,enhanced,arc=3.5mm,outer arc=3.5mm,
		boxrule=0pt,toprule=1pt,leftrule=0pt,bottomrule=1pt, rightrule=0pt,left=0.2cm,right=0.2cm,
		titlerule=0.5em,toptitle=0.1cm,bottomtitle=-0.1cm,top=0.2cm,
		colframe=white!10!merah,colback=white!75!pink,coltitle=white, coltext=merahtua!80!merah,
		shadow={1.3mm}{-1.3mm}{0mm}{gray!50!white!90}, % æ·»åŠ é˜´å½±
		title style={white!10!merah}, before skip=8pt, after skip=8pt,
		fonttitle=\bfseries,fontupper=\normalsize}{thm}
	
	% Proposition
	\newtcbtheorem[use counter=hitung, number within=section]{prp}{å‘½é¢˜}
	{theorem style=theorem wide name and number,breakable,enhanced,arc=3.5mm,outer arc=3.5mm,
		boxrule=0pt,toprule=1pt,leftrule=0pt,bottomrule=1pt, rightrule=0pt,left=0.2cm,right=0.2cm,
		titlerule=0.5em,toptitle=0.1cm,bottomtitle=-0.1cm,top=0.2cm,
		colframe=white!10!hijau,colback=white!90!hijau,coltitle=white, coltext=hijautua!80!brown,
		shadow={1.3mm}{-1.3mm}{0mm}{gray!50!white}, % æ·»åŠ é˜´å½±
		title style={white!10!hijau}, before skip=8pt, after skip=8pt,
		fonttitle=\bfseries,fontupper=\normalsize}{prp}


	% Example
	\newtcolorbox[use counter=hitung, number within=section]{cth}[1][]{breakable,
		colframe=white!10!jingga, coltitle=white!90!jingga, colback=white!85!jingga, coltext=black!10!brown!50!jingga, colbacktitle=white!10!jingga, enhanced, fonttitle=\bfseries,fontupper=\normalsize, attach boxed title to top left={yshift=-2mm}, before skip=8pt, after skip=8pt,
		title=Itemize~\thetcbcounter \ \ #1}

	% Catatan/Note
	\newtcolorbox{ctt}[1][]{enhanced, 
		left=4.1mm, borderline west={8pt}{0pt}{white!10!kuning}, 
		before skip=6pt, after skip=6pt, 
		colback=white!85!kuning, colframe= white!85!kuning, coltitle=orange!60!kuning!25!brown, coltext=orange!60!kuning!25!brown,
		fonttitle=\bfseries,fontupper=\normalsize, before skip=8pt, after skip=8pt,
		title=\underline{Notice}  #1}
	
	% Komentar/Remark
	\newtcolorbox{rmr}[1][]{
		,arc=0mm,outer arc=0mm,
		boxrule=0pt,toprule=1pt,leftrule=0pt,bottomrule=5pt, rightrule=0pt,left=0.2cm,right=0.2cm,
		titlerule=0.5em,toptitle=0.1cm,bottomtitle=-0.1cm,top=0.2cm,
		colframe=white!10!kuning,colback=white!85!kuning,coltitle=white, coltext=orange!60!kuning,
		fonttitle=\bfseries,fontupper=\normalsize, before skip=8pt, after skip=8pt,
		title=Question  #1}

\usepackage{booktabs} % è¡¨æ ¼åº“
\usepackage{titlesec} % æ ‡é¢˜åº“
\usepackage{fancyhdr} % é¡µçœ‰é¡µè„šåº“
\usepackage[sorting=none]{biblatex}
\usepackage{array}
\usepackage{longtable}
\usetikzlibrary{positioning, arrows.meta}
\addbibresource{references.bib} % æŒ‡å®šä½ çš„.bibæ–‡ä»¶åç§°

\date{} % ç•™ç©ºï¼Œä»¥è®©ç¼–è¯‘æ—¶å»é™¤æ—¥æœŸ

%â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”æ³¨æ„äº‹é¡¹â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”%

% 1ã€å¦‚æœç¼–è¯‘æ˜¾ç¤ºå¤±è´¥ï¼Œä½†æ²¡æœ‰é”™è¯¯ä¿¡æ¯ï¼Œå°±æ˜¯ filename.pdf æ­£åœ¨è¢«å ç”¨
% 2ã€åœ¨æ–‡ä»¶å¤¹ä¸­çš„ç»ˆç«¯ä½¿ç”¨ Windows > xelatex filename.tex ä¹Ÿå¯ç¼–è¯‘

%â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”åä¸œå¸ˆèŒƒå¤§å­¦â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”%

% è®ºæ–‡åˆ¶ä½œæ—¶é¡»åŠ é¡µçœ‰ï¼Œé¡µçœ‰ä»ä¸­æ–‡æ‘˜è¦å¼€å§‹è‡³è®ºæ–‡æœ«
% å¶æ•°é¡µç å†…å®¹ä¸ºï¼šåä¸œå¸ˆèŒƒå¤§å­¦ç¡•å£«å­¦ä½è®ºæ–‡ï¼Œå¥‡æ•°é¡µç å†…å®¹ä¸ºå­¦ä½è®ºæ–‡é¢˜ç›®

%â€”â€”â€”â€”â€”â€”â€”â€”å®šä¹‰ \section çš„æ ‡é¢˜æ ·å¼â€”â€”â€”â€”â€”â€”â€”â€”%

% æ³¨æ„ï¼š\chapter ç­‰å‘½ä»¤ï¼Œå†…éƒ¨ä½¿ç”¨çš„æ˜¯ \thispagestyle{plain} çš„æ’ç‰ˆæ ¼å¼
% è‹¥éœ€è¦è‡ªå·±åŠ ä¸Šé¡µçœ‰ï¼Œå®é™…æ˜¯åœ¨ç”¨ \thispagestyle{fancy} çš„æ’ç‰ˆæ ¼å¼
% åŠ ä¸Šä¸‹é¢è¿™ä¸€æ®µæŒ‡ä»¤ï¼Œå°±èƒ½å¤Ÿè®© \section ä¹Ÿä½¿ç”¨ fancy çš„æ’ç‰ˆæ ¼å¼
% æœ¬è´¨å°±æ˜¯è®©ç›®å½•ã€ç¬¬ä¸€é¡µä¹Ÿèƒ½å¤Ÿæ˜¾ç¤ºé¡µçœ‰ã€é¡µè„š

\fancypagestyle{plain}{
  \pagestyle{fancy}
}

\title{åä¸œå¸ˆèŒƒå¤§å­¦è½¯ä»¶å­¦é™¢å®éªŒæŠ¥å‘Š} % æ¨¡æ¿
\titleformat{\section}
    {\normalfont\bfseries\Large} % å­—ä½“å¤§å°ã€å­—ä½“ç³»åˆ—ï¼ˆ\bfseries ä¸ºåŠ ç²—ï¼‰
    {\thesection}{1em}{}

% â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”è®¾ç½®ç« èŠ‚çš„ä¸­æ–‡æ ¼å¼â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”%
\renewcommand\thesection{\chinese{section} \hspace{0pt}}
\renewcommand\thesubsection{\arabic{subsection} \hspace{0pt}}
% \renewcommand\thesubsubsection{\alph{subsubsection} \hspace{0pt}} % å­—æ¯ç¼–å·
% \hspace{0pt} æ˜¯ä¸ºäº†ç¡®ä¿åœ¨ç« èŠ‚ç¼–å·å’Œç« èŠ‚é¢˜ç›®ä¹‹é—´ä¸è¦æœ‰ç©ºæ ¼ï¼Œä½¿å¾—æ’ç‰ˆæ›´ä¸ºç¾è§‚
    
%â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”é¡µé¢åŸºç¡€è®¾ç½®â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”%

\usepackage{geometry}
\geometry{left=10mm, right=10mm, top=20mm, bottom=20mm}

%â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”è®¾ç½®é¡µçœ‰ã€é¡µè„šâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”%

\pagestyle{fancy} % è®¾ç½® plain style çš„å±æ€§

% è®¾ç½®é¡µçœ‰

\fancyhead[RE]{\footnotesize \leftmark} % Right Even å¶æ•°é¡µå³ä¾§æ˜¾ç¤ºç« å \leftmark æœ€é«˜çº§åˆ«ç« å
\fancyhead[LO]{\footnotesize \rightmark} % Left Odd å¥‡æ•°é¡µå·¦ä¾§æ˜¾ç¤ºèŠ‚å \rightmark ç¬¬äºŒçº§åˆ«èŠ‚å
\fancyhead[C]{åä¸œå¸ˆèŒƒå¤§å­¦è½¯ä»¶å­¦é™¢å®éªŒæŠ¥å‘Š} % Center å±…ä¸­æ˜¾ç¤º
\fancyhead[LE,RO]{~\thepage~} % åœ¨å¶æ•°é¡µçš„å·¦ä¾§ï¼Œå¥‡æ•°é¡µçš„å³ä¾§æ˜¾ç¤ºé¡µç 
\renewcommand{\headrulewidth}{1.2pt} % é¡µçœ‰ä¸æ­£æ–‡ä¹‹é—´çš„æ°´å¹³çº¿ç²—ç»†

% è®¾ç½®é¡µè„šï¼šåœ¨æ¯é¡µçš„å³ä¸‹è„šä»¥æ–œä½“æ˜¾ç¤ºä¹¦å

\fancyfoot[RO,RE]{\it Lab Report By \LaTeX} % ä½¿ç”¨æ„å¤§åˆ©æ–œä½“æ˜¾ç¤º
\renewcommand{\footrulewidth}{0.5pt} % é¡µè„šæ°´å¹³çº¿å®½åº¦

%â€”â€”â€”â€”â€”â€”è®¾ç½®é¡µç ï¼šåœ¨åº•éƒ¨å±…ä¸­æ˜¾ç¤ºé¡µç â€”â€”â€”â€”â€”â€”â€”%

\usepackage{lastpage} % é¡µç æ•°åº“
\pagestyle{fancy}
\fancyfoot[C]{\kaishu ç¬¬ \thepage é¡µ \ å…± \pageref{LastPage} é¡µ} % LastPage éœ€è¦äºŒæ¬¡ç¼–è¯‘ä»¥è·å–æ€»é¡µæ•°

%â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”ä»£ç å—è®¾ç½®â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”%

\usepackage{listings} % ä»£ç å—åŒ…
\lstset {
    backgroundcolor=\color{white},   % choose the background color; you must add \usepackage{color} or \usepackage{xcolor}
    basicstyle=\footnotesize,        % the size of the fonts that are used for the code
    breakatwhitespace=false,         % sets if automatic breaks should only happen at whitespace
    breaklines=true,                 % sets automatic line breaking
    captionpos=bl,                   % sets the caption-position to bottom
    commentstyle=\color{mygreen},    % comment style
    deletekeywords={...},            % if you want to delete keywords from the given language
    escapeinside={\%*}{*},           % if you want to add LaTeX within your code
    extendedchars=true,              % lets you use non-ASCII characters; for 8-bits encodings only, does not work with UTF-8
    frame=single,                    % adds a frame around the code
    keepspaces=true,                 % keeps spaces in text, useful for keeping indentation of code (possibly needs columns=flexible)
    keywordstyle=\color{blue},       % keyword style
    % language=Python,               % the language of the code
    morekeywords={*,...},            % if you want to add more keywords to the set
    numbers=left,                    % where to put the line-numbers; possible values are (none, left, right)
    numbersep=5pt,                   % how far the line-numbers are from the code
    numberstyle=\tiny\color{mygray}, % the style that is used for the line-numbers
    rulecolor=\color{black},         % if not set, the frame-color may be changed on line-breaks within not-black text (e.g. comments (green here))
    showspaces=false,                % show spaces everywhere adding particular underscores; it overrides 'showstringspaces'
    showstringspaces=false,          % underline spaces within strings only
    showtabs=false,                  % show tabs within strings adding particular underscores
    stepnumber=1,                    % the step between two line-numbers. If it's 1, each line will be numbered
    stringstyle=\color{orange},      % string literal style
    tabsize=2,                       % sets default tabsize to 2 spaces
    % title=Python Code              % show the filename of files included with \lstinputlisting; also try caption instead of title
}

% æ³¨é‡Šæ‰çš„éƒ¨åˆ†ç”¨äºåç»­æ’å…¥ä»£ç ï¼Œå‚æ•°å¯è°ƒæ•´ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

% 1ã€ç›´æ¥æ’å…¥
% \begin{lstlisting}[language = ? , title = { ? } ]
%       Your code here.
% \end{lstlisting}

% 2ã€æ–‡ä»¶æ’å…¥
% \lstinputlisting[language = C , title = ?.c] {filename.c}

%â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”å­—ä½“è®¾ç½®â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”%

\usepackage{fontspec} % å…è®¸è®¾ç½®å­—ä½“
\usepackage[utf8]{inputenc}
\usepackage{ctex}
\usepackage{pifont}
\linespread{1.2}
% \setCJKmainfont{SimSun} % è®¾ç½®æ­£æ–‡ç½—é©¬æ—çš„ CJK å­—ä½“
\renewcommand{\texttt}[1]{\textcolor{blue}{\ttfamily #1}}

%â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”è¶…é“¾æ¥è®¾ç½®â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”%

\usepackage[hidelinks]{hyperref}
\hypersetup{
    pdfstartview=FitH, % è®¾ç½®PDFæ–‡æ¡£æ‰“å¼€æ—¶çš„åˆå§‹è§†å›¾ä¸ºé¡µé¢å®½åº¦é€‚åº”çª—å£å®½åº¦ï¼ˆå³é¡µé¢æ°´å¹³é€‚åº”ï¼‰
    CJKbookmarks=true, % ç”¨å¯¹CJKï¼ˆä¸­æ–‡ã€æ—¥æ–‡ã€éŸ©æ–‡ï¼‰å­—ç¬¦çš„ä¹¦ç­¾æ”¯æŒï¼Œç¡®ä¿è¿™äº›å­—ç¬¦åœ¨ä¹¦ç­¾ä¸­æ­£ç¡®æ˜¾ç¤º
    bookmarksnumbered=true, % ä¹¦ç­¾å¸¦æœ‰ç« èŠ‚ç¼–å·ã€‚è¿™å¯¹æœ‰ç« èŠ‚ç¼–å·çš„æ–‡æ¡£å¾ˆæœ‰ç”¨
    bookmarksopen=true, % æ–‡æ¡£æ‰“å¼€æ—¶ï¼Œä¹¦ç­¾æ ‘æ˜¯å±•å¼€çš„ï¼Œæ–¹ä¾¿æŸ¥çœ‹æ‰€æœ‰ä¹¦ç­¾
    colorlinks, % å¯ç”¨å½©è‰²é“¾æ¥ã€‚è¿™æ ·ï¼Œé“¾æ¥åœ¨PDFä¸­ä¼šæ˜¾ç¤ºä¸ºå½©è‰²ï¼Œè€Œä¸æ˜¯é»˜è®¤çš„æ–¹æ¡†
    pdfborder=001, % è®¾ç½®PDFæ–‡æ¡£ä¸­é“¾æ¥çš„è¾¹æ¡†æ ·å¼ã€‚001 è¡¨ç¤ºé“¾æ¥å‘¨å›´æ²¡æœ‰è¾¹æ¡†ï¼Œä»…åœ¨å•å‡»æ—¶æ˜¾ç¤ºä¸€ä¸ªçŸ©å½¢
    linkcolor=blue, % è®¾ç½®æ–‡æ¡£å†…éƒ¨é“¾æ¥ï¼ˆå¦‚ç›®å½•ä¸­çš„ç« èŠ‚é“¾æ¥ï¼‰çš„é¢œè‰²ä¸ºè“è‰²
    anchorcolor=blue, % è®¾ç½®é”šç‚¹é“¾æ¥ï¼ˆå³ç›®æ ‡åœ¨åŒä¸€æ–‡æ¡£å†…çš„é“¾æ¥ï¼‰çš„é¢œè‰²ä¸ºè“è‰²
    citecolor=blue, % è®¾ç½®å¼•ç”¨ï¼ˆå¦‚æ–‡çŒ®å¼•ç”¨ï¼‰çš„é¢œè‰²ä¸ºè“è‰²
}

%â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”å¯¼è¨€åŒºç»“æŸï¼Œè¿›å…¥æ­£æ–‡éƒ¨åˆ†â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”%

\begin{document}

\maketitle

\begin{center} % \extracolsep{\fill} æ‹‰ä¼¸åˆ°é¡µé¢æœ€å¤§å®½åº¦å‰ï¼Œä¿è¯å±…ä¸­æ˜¾ç¤º

    \begin{tabular*}{\textwidth}{@{\extracolsep{\fill}} l  l  l }
        \hline
        è¯¾ç¨‹åç§°ï¼šæ“ä½œç³»ç»Ÿ &  å¹´çº§ï¼š2023çº§æœ¬ç§‘  &  ä¸Šæœºå®è·µæˆç»©ï¼š\ \ \ \ \ \ \ \ \ \ \ \ \ \\
        æŒ‡å¯¼æ•™å¸ˆï¼šå¼ æ°‘ & å§“åï¼šå¼ æ¢“å« \\
        ä¸Šæœºå®è·µåç§°ï¼šPintos Userprog Part 1 & å­¦å·ï¼š10235101526 & ä¸Šæœºå®è·µæ—¥æœŸï¼š2024/12/16 \ \ \ \ \ \ \ \ \ \ \ \ \ \\
        ä¸Šæœºå®è·µç¼–å·ï¼šï¼ˆ5ï¼‰ & ç»„å·ï¼š & ä¸Šæœºå®è·µæ—¶é—´ï¼š2 å­¦æ—¶ \ \ \ \ \ \ \ \ \ \ \ \ \ \\
        \hline
      \end{tabular*}

\end{center}

\tableofcontents % ç›®å½•ä¹Ÿéœ€è¦äºŒæ¬¡ç¼–è¯‘

\section{å®éªŒç›®çš„}

æœ¬å®éªŒçš„ç›®æ ‡æ˜¯å®Œæˆå‚æ•°ä¼ é€’å’Œéƒ¨åˆ†ç³»ç»Ÿè°ƒç”¨ï¼ˆexitå’Œwriteï¼‰ï¼Œä½¿å¾—make checké€šè¿‡argsç›¸å…³çš„5ä¸ªæµ‹è¯•ã€‚

æœ¬é¡¹ç›®çš„ä¸»è¦ä»»åŠ¡ï¼šå®ç°ç”¨æˆ·ç¨‹åºå’ŒOSä¹‹é—´çš„ç³»ç»Ÿè°ƒç”¨ã€‚æœ¬æ¬¡å®éªŒä½œå‡ºä¿®æ”¹çš„ä»£ç åŒæ—¶ä¸Šä¼ åˆ°äº† Github ä¹‹ä¸Šï¼Œ
ä»“åº“åœ°å€ä¸ºï¼š\href{https://github.com/Shichien/ECNU-23-SEI-Homework/tree/main/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E5%AE%9E%E8%B7%B5%E8%AF%BE%E4%BD%9C%E4%B8%9A/Lec%202/lst2}{\underline{https://github.com/Shichien/ECNU-23-SEI-Homework}}

è¯·åœ¨ä¸Šä¼ çš„ PDF æ–‡ä»¶ä¸­ç›´æ¥ç‚¹å‡»ç²‰è‰²é“¾æ¥å³å¯ã€‚

\section{å†…å®¹ä¸è®¾è®¡æ€æƒ³}

\begin{itemize}
    \item å‚æ•°ä¼ é€’ï¼Œç³»ç»Ÿè°ƒç”¨
\end{itemize}

\begin{ctt}
\begin{itemize}
    \item ç¼–è¯‘ç”Ÿæˆbuildæ–‡ä»¶å¤¹
    \item åˆ›å»ºç”¨æˆ·ç£ç›˜
    \item ä¿®æ”¹process\_execute()å®ç°æ–‡ä»¶åä¸å‚æ•°åˆ†ç¦»
    \item ä¿®æ”¹load()å®ç°æ–‡ä»¶åä¸å‚æ•°åˆ†ç¦»å¹¶å°†å¯æ‰§è¡Œæ–‡ä»¶å­˜åˆ°ESPä¸­
    \item ä¿®æ”¹setup\_stack()å®ç°å‚æ•°å †æ ˆ
    \item æ³¨ï¼šä¸Šè¿°æ–¹æ³•å‡ä½äºuserprog/process.cä¸­
\end{itemize}
\end{ctt}

è¯¥å¼€å§‹ç€æ‰‹ç ”ç©¶å…è®¸è¿è¡Œç”¨æˆ·ç¨‹åºçš„ç³»ç»Ÿéƒ¨åˆ†äº†ã€‚åŸºæœ¬ä»£ç å·²ç»æ”¯æŒåŠ è½½å’Œè¿è¡Œç”¨æˆ·ç¨‹
åºï¼Œä½†æ˜¯æ— æ³•è¿›è¡Œ I / O æˆ–äº¤äº’ã€‚åœ¨æ­¤é¡¹ç›®ä¸­ï¼Œå°†ä½¿ç¨‹åºèƒ½å¤Ÿé€šè¿‡ç³»ç»Ÿè°ƒç”¨ä¸ OS è¿›è¡Œäº¤
äº’ï¼Œå¹¶ä¸ºç”¨æˆ·è¿›ç¨‹æä¾›ç³»ç»Ÿè°ƒç”¨ã€‚åœ¨ Project 1 ä¸­ï¼Œæ‰§è¡Œçš„æ“ä½œéƒ½æ˜¯åœ¨å†…æ ¸æ¨¡å¼ä¸‹è¿è¡Œçš„ï¼Œ
è€Œåœ¨è¿™ä¸ª Project ä¸­è¦æ±‚æˆ‘ä»¬å¯¹éå†…æ ¸è¿›è¡Œä¿®æ”¹ã€‚

\begin{itemize}
    \item src/userprog
    \item process.c/ process.hï¼šè¿›ç¨‹ä»£ç ï¼ˆéœ€ä¿®æ”¹ï¼‰â­
    \item pagedir.c/pagedir.hï¼šç‰©ç†å†…å­˜ç®¡ç†ï¼ˆä¸éœ€ä¿®æ”¹ï¼Œå¯ä»¥è°ƒç”¨å®ç°çš„ï¼‰
    \item syscall.c/syscall.hï¼šç³»ç»Ÿè°ƒç”¨ï¼Œç›®å‰åªæ­äº†éª¨æ¶ï¼ˆéœ€ä¿®æ”¹ï¼‰ğŸŒŸ
    \item exception.c/exception.hï¼šå¼‚å¸¸å¤„ç†æƒ…å†µï¼ˆéœ€ä¿®æ”¹ï¼‰ 
    \item gdt.c/gdt.hï¼šå…¨å±€æè¿°è¡¨ï¼ˆä¸éœ€ä¿®æ”¹ï¼‰
    \item tss.c/tss.hï¼šä»»åŠ¡çŠ¶æ€æ®µï¼ˆä¸éœ€ä¿®æ”¹ï¼‰
\end{itemize}

\section{ä½¿ç”¨ç¯å¢ƒ}

ä½¿ç”¨ Docker v27.1.1 è¿›è¡ŒPintosçš„å®‰è£…å®éªŒï¼ŒåŸºäº Windows 11 æ“ä½œç³»ç»Ÿä½¿ç”¨ WSL2ã€‚

å®éªŒæŠ¥å‘Šä½¿ç”¨ \LaTeX è¿›è¡Œæ’°å†™ï¼Œä½¿ç”¨ VSCode + Vim ç¼–è¾‘å™¨è¿›è¡Œæ–‡æœ¬ç¼–è¾‘ã€‚

\section{å®éªŒè¿‡ç¨‹ä¸åˆ†æ}

\subsection{è¿›å…¥å®éªŒèƒŒæ™¯}

è¿›å…¥ \texttt{cd src/pintos/userprog} ä¸­ä½¿ç”¨ \texttt{make} å‘½ä»¤ç¼–è¯‘

ç„¶åä½¿ç”¨ \texttt{cd build} è¿›å…¥åˆ° build æ–‡ä»¶å¤¹ä¸­å»ºç«‹ä¸€ä¸ªæ–°çš„ç”¨æˆ·ç£ç›˜ã€‚

\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\textwidth]{img5/createfilesys.png}
    \caption{ç¼–è¯‘}
    \label{fig:make}
\end{figure}

æ³¨æ„åˆ°è¿™é‡Œç›´æ¥ä½¿ç”¨ \texttt{pintos -f -q} ä¼šæç¤ºæœªçŸ¥çš„å‚æ•°ï¼Œè¦ä¿®æ”¹ä¸ºï¼š\texttt{pintos -- -f -q}ï¼Œæ‰èƒ½ç¼–è¯‘æˆåŠŸã€‚

æ¥ä¸‹æ¥ï¼Œæ‰§è¡Œä¸‹ä¸€æ¡å‘½ä»¤ï¼Œå°† echo.c å¤åˆ¶åˆ°ç£ç›˜ä¸­ï¼Œä¸”å‘½åä¸º echoã€‚

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{img5/copy.png}
    \caption{å¤åˆ¶æ–‡ä»¶}
    \label{fig:copyfile}
\end{figure}

åœ¨æœªå®ç°å‚æ•°ä¼ é€’æ—¶ï¼Œæˆ‘ä»¬ç›´æ¥æ‰§è¡Œ \texttt{pintos -- -q run 'echo x'} è¿™æ ·çš„å‘½ä»¤å…¶å®æ˜¯å¾ˆä¸åˆç†çš„ã€‚
è¿™ä¸ªè¾“å…¥çš„å«ä¹‰æ˜¯ï¼šæ‰§è¡Œechoæ–‡ä»¶ï¼Œä¼ é€’çš„å‚æ•°æ˜¯xã€‚ å®é™…ä¸Šï¼Œecho x è¢«å½“æˆäº†ä¸€ä¸ªæ•´ä½“æ¥å¤„ç†ã€‚

\begin{figure}[H]
    \centering
    \includegraphics[width=0.65\textwidth]{img5/echo.png}
    \caption{Echo}
    \label{fig:echo}
\end{figure}

\subsection{å¼€å§‹åˆ†æä»£ç }

å…ˆæŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ä¸­å¯¹ç›®å‰æ¸…ç©ºçš„ä»‹ç»ï¼š

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{img5/ref.png}
    \caption{Pintos References}
    \label{fig:ref}
\end{figure}

\begin{mdframed}
    ç¿»è¯‘å¦‚ä¸‹ï¼š
    
    ç›®å‰ï¼Œprocess\_execute()ä¸æ”¯æŒå‘æ–°è¿›ç¨‹ä¼ é€’å‚æ•°ã€‚
é€šè¿‡æ‰©å±•process\_execute()æ¥å®ç°æ­¤åŠŸèƒ½ï¼Œè€Œä¸æ˜¯ç®€å•çš„taskã€‚
å°†ç¨‹åºfilenameä½œä¸ºå…¶å‚æ•°ï¼Œå®ƒåœ¨ç©ºæ ¼å¤„å°†å…¶æ‹†åˆ†ä¸ºå•è¯ã€‚ç¬¬ä¸€ä¸ªè¯
æ˜¯ç¨‹åºåï¼Œç¬¬äºŒä¸ªå•è¯æ˜¯ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œä»¥æ­¤ç±»æ¨ã€‚ä¹Ÿå°±æ˜¯.process
executeï¼ˆâ€œgrep-foo-barâ€ï¼‰åº”è¯¥è¿è¡Œgrepï¼Œä¼ é€’ä¸¤ä¸ªå‚æ•°fooå’Œbarã€‚
åœ¨å‘½ä»¤è¡Œä¸­å¤šä¸ªç©ºæ ¼ç›¸å½“äºä¸€ä¸ªç©ºæ ¼ï¼Œä»¥ä¾¿è¿›ç¨‹æ‰§è¡Œï¼ˆâ€œgrep-foo-barâ€ï¼‰ä¸æˆ‘ä»¬æœ€åˆçš„ç¤ºä¾‹ç­‰æ•ˆã€‚
\end{mdframed}

æŸ¥çœ‹ç›¸å…³çš„ä»£ç å¤„ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä»¥ä¸‹å†…å®¹ï¼š

\begin{lstlisting}[language=C,title=process]
    tid_t process_execute (const char *file_name) {
      char *fn_copy;
      tid_t tid;
    
      /* Make a copy of FILE_NAME.
         Otherwise there's a race between the caller and load(). */
      fn_copy = palloc_get_page (0);
      if (fn_copy == NULL)
        return TID_ERROR;
      strlcpy (fn_copy, file_name, PGSIZE);
    
      /* Create a new thread to execute FILE_NAME. */
      tid = thread_create (file_name, PRI_DEFAULT, start_process, fn_copy);
      if (tid == TID_ERROR)
        palloc_free_page (fn_copy); 
      return tid;
    }
\end{lstlisting}

\begin{ctt}
åœ¨ä¼ é€’å‚æ•°æ—¶ï¼Œä¼ é€’ \texttt{process\_execute} å‡½æ•°çš„å‚æ•° \texttt{file\_name} æ—¢åŒ…æ‹¬
å¯æ‰§è¡Œæ–‡ä»¶çš„åç§°ï¼Œä¹ŸåŒ…å«äº†å¯æ‰§è¡Œæ–‡ä»¶çš„å‚æ•°ã€‚
æ‰€ä»¥ï¼Œè¦åšçš„ç¬¬ä¸€ä»¶äº‹å°±æ˜¯æ¢æŠŠå¯æ‰§è¡Œæ–‡ä»¶åç§°å’Œå‚æ•°äº’ç›¸åˆ†å¼€ã€‚
æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ \texttt{string.h} ä¸­çš„ \texttt{strtok\_r()} æ¥åˆ†ç¦»å‚æ•°ã€‚
\end{ctt}

\begin{lstlisting} [language=C,title=process]
    tid_t process_execute (const char *file_name) {
      char *fn_copy;
      char *thread_name;
      char *save_ptr; // ç”¨æ¥ä¿å­˜strtok_rçš„çŠ¶æ€
    
      thread_name = malloc(strlen(file_name) + 1);
      strlcpy(thread_name, file_name, strlen(file_name) + 1);
      // æ‹·è´ file_name åˆ°åŠ¨æ€åˆ†é…çš„ thread_nameï¼Œä»¥ä¾¿åç»­é€šè¿‡ strtok_r æˆªå–çº¿ç¨‹åç§°
      thread_name = strtok_r(thread_name, " ", &save_ptr); // åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ç”¨æ¥è¿è¡Œ"æ–‡ä»¶å"
      tid_t tid;
    
      /* Make a copy of FILE_NAME.
         Otherwise there's a race between the caller and load(). */
      fn_copy = palloc_get_page (0);
      if (fn_copy == NULL)
        return TID_ERROR;
      strlcpy (fn_copy, file_name, PGSIZE);
    
      /* Create a new thread to execute FILE_NAME. */
      tid = thread_create (file_name, PRI_DEFAULT, start_process, fn_copy);
      free(thread_name); // é‡Šæ”¾ç”± malloc åˆ›å»ºçš„çº¿ç¨‹å
      if (tid == TID_ERROR)
        palloc_free_page (fn_copy); 
      return tid;
    }
\end{lstlisting}

\begin{ctt}
è¿™é‡Œæˆ‘ä»¬é¦–å…ˆåœ¨æœ€å¼€å§‹æ·»åŠ ä¸¤ä¸ª char *ç±»å‹å˜é‡ï¼Œ\texttt{*save\_ptr} æŒ‡å‘
\texttt{file\_name} çš„ä¸€ä¸ªæ‹·è´ï¼Œæ˜¯ä¸ºäº†å®ç°ä¿å­˜ä»å‘½ä»¤è¯­å¥ä¸­åˆ†ç¦»å‡ºæ¥çš„çœŸæ­£çš„å¯æ‰§è¡Œæ–‡
ä»¶åï¼Œç»™ fn åˆ†é…ä¸å‘½ä»¤è¯­å¥å®¹é‡ç›¸ç­‰çš„å†…å­˜ç©ºé—´ã€‚
\end{ctt}

\subsubsection{åˆ†æ start\_process()}

æˆ‘ä»¬åœ¨å‡½æ•°ä¸­å°† \texttt{file\_name} é€šè¿‡ load å­˜å‚¨åˆ°æ ˆä¸­ã€‚

ä¸‹é¢è¿™ä¸ªæ˜¯ Pintos ä¸­çš„åŸå§‹ä»£ç ã€‚

\begin{lstlisting} [language=C,title=start\_process]
    static void
    start_process (void *file_name_)
    {
      char *file_name = file_name_;
      struct intr_frame if_;
      bool success;
    
      /* Initialize interrupt frame and load executable. */
      memset (&if_, 0, sizeof if_);
      if_.gs = if_.fs = if_.es = if_.ds = if_.ss = SEL_UDSEG;
      if_.cs = SEL_UCSEG;
      if_.eflags = FLAG_IF | FLAG_MBS;
      success = load (file_name, &if_.eip, &if_.esp);
    
      /* If load failed, quit. */
      palloc_free_page (file_name);
      if (!success) 
        thread_exit ();
    
      /* Start the user process by simulating a return from an
         interrupt, implemented by intr_exit (in
         threads/intr-stubs.S).  Because intr_exit takes all of its
         arguments on the stack in the form of a `struct intr_frame',
         we just point the stack pointer (%esp) to our stack frame
         and jump to it. */
      asm volatile ("movl %0, %%esp; jmp intr_exit" : : "g" (&if_) : "memory");
      NOT_REACHED ();
    }
\end{lstlisting}

ä¿®æ”¹åçš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

\begin{lstlisting}[ language=C,title=process ]
    char *token, *save_ptr;
    file_name = strtok_r(file_name, " ", &save_ptr); // è·å–æ–‡ä»¶å
    success = load (file_name, &if_.eip, &if_.esp);
\end{lstlisting}

\subsubsection{åˆ†æ load() å‡½æ•°}

ä¸»è¦æ˜¯å°†ä»FILE\_NAMEè·å–çš„å¯æ‰§è¡Œçš„ç¨‹åºæ”¾å…¥åˆ°å½“å‰çº¿ç¨‹ä¸­ã€‚

é’ˆå¯¹ä¼ å‚ï¼Œæˆ‘ä»¬éœ€è¦ç¬¬äºŒæ¬¡å‚æ•°åˆ†ç¦»ï¼šä¼ é€’è¿‡æ¥çš„æ˜¯\texttt{file\_name="args-single onearg"}ã€‚

\begin{lstlisting}[language=C, title= load]
    /* Separate file name and arguments. */
    char *exec_name;
    char *save_ptr;
  
    /* Make a modifiable copy of file_name. */
    char modifiable_file_name[PGSIZE];
    strlcpy(modifiable_file_name, file_name, PGSIZE);
  
    /* Extract the executable name (first token). */
    exec_name = strtok_r(modifiable_file_name, " ", &save_ptr);
  
    /* Open the executable file. */
    file = filesys_open(exec_name);
    if (file == NULL) 
    {
      printf ("load: %s: open failed\n", exec_name);
      goto done; 
    }
\end{lstlisting}

å¦å¤–ï¼Œåœ¨ load() å‡½æ•°ä¸­ï¼Œæ³¨é‡Šä¸­å†™æ˜äº† \texttt{setup\_stack()} å‡½æ•°çš„ä½œç”¨æ˜¯è®¾ç½®å‚æ•°å †æ ˆã€‚

\begin{figure}[H]
    \centering
    \includegraphics[width=0.3\textwidth]{img5/setup.png}
    \caption{load()}
    \label{fig:load}
\end{figure}

è€Œåœ¨ \texttt{setup\_stack()} å‡½æ•°ä¸­ï¼Œå®ƒä»…ä»…å®ç°äº†é¡µçš„åˆå§‹åŒ–ï¼Œå¹¶æ²¡æœ‰å‚æ•°ä¼ é€’å®ç°çš„ä»£ç ã€‚

å› æ­¤æˆ‘ä»¬éœ€è¦å°†ç”¨strokåˆ†ç¦»å‡ºçš„filenameä»¥åŠargvä¼ é€’è¿›å»ã€‚

ä¸€ä¸ªå®ç°æ€è·¯æ˜¯ï¼Œåœ¨ \texttt{setup\_stack()} å‡½æ•°ä¸­æ·»åŠ å‚æ•° \texttt{file\_name} å’Œ \texttt{save\_ptr}

\begin{figure}[H]
    \centering
    \begin{subfigure}[b]{0.45\textwidth}
        \centering
        \includegraphics[width=\textwidth]{img5/stack.png}
        \label{fig:left_stack}
    \end{subfigure}
    \hfill
    \begin{subfigure}[b]{0.42\textwidth}
        \centering
        \includegraphics[width=\textwidth]{img5/stackover.png}
        \label{fig:right_stack}
    \end{subfigure}
    \label{fig:stack_subfigures}
\end{figure}

\begin{ctt}
\textbf{if\_.esp} åŸæ¥æŒ‡å‘espçš„å†…æ ¸å’Œç”¨æˆ·åŒºè¾¹ç•Œä¸ºé¿å…å†…å­˜è®¿é—®è¶Šç•Œï¼ˆè®¿é—®åˆ°å†…æ ¸åŒºï¼‰

æ‰€ä»¥éœ€å°†\texttt{setup\_stack()}å‡½æ•°ä¸­çš„\texttt{esp = PHYS\_BASE}
ä¿®æ”¹æˆ \texttt{*esp = PHYS\_BASE - 12;}

åæ¥ï¼Œæ–‡æ¡£ä¸­è¿˜é™„åŠ äº†ä¸€æ¡å¯¹äº \textbf{bin/ls -l foo bar} å‘½ä»¤æ‰§è¡Œæ—¶æ ˆçš„å¢é•¿æƒ…å†µï¼š
\end{ctt}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.55\textwidth]{img5/example.png}
    \caption{ç¤ºä¾‹æ ˆå¢é•¿}
    \label{fig:ls}
\end{figure}

æ ¹æ® PPT ä¸Šçš„æç¤ºï¼Œæˆ‘ä»¬ç¼–å†™ä»¥ä¸‹ä»£ç æ¥å®ç°åˆå§‹åŒ–æ ˆï¼š

å¦å¤–ï¼Œå®˜æ–¹æ–‡æ¡£ä¸­è¿˜æåˆ°äº†æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ \textbf{hex\_dump()} å‡½æ•°æ¥æ‰“å°æ­¤æ—¶æ ˆçš„ä¿¡æ¯ï¼Œä¸å¦¨æ·»åŠ è¿›å»ã€‚

\begin{figure}[H]
    \centering
    \includegraphics[width=0.5\textwidth]{img5/tips.png}
    \caption{hex\_dump()}
    \label{fig:hex}
\end{figure}

åœ¨å‡½æ•°ä¸­ï¼Œå†™å¥½äº†ä¸ºä»€ä¹ˆè¦ç”¨è¿™æ ·çš„æ–¹å¼å®ç°çš„å…·ä½“æ³¨é‡Šï¼š

\begin{lstlisting}[language=C, title= setup\_stack]
    static bool
    setup_stack (void **esp, char* file_name)
    {
      uint8_t *kpage;
      bool success = false;
    
      // åˆ†é…ä¸€é¡µç”¨æˆ·å†…å­˜å¹¶å°†å…¶å®‰è£…åˆ°ç”¨æˆ·æ ˆçš„é¡¶éƒ¨
      kpage = palloc_get_page (PAL_USER | PAL_ZERO);
      if (kpage != NULL) 
        {
          success = install_page (((uint8_t *) PHYS_BASE) - PGSIZE, kpage, true);
          if (success)
            *esp = PHYS_BASE - 12;  // åˆå§‹åŒ–æ ˆæŒ‡é’ˆåˆ°æ ˆé¡¶
          else
            palloc_free_page (kpage);
        }
    
      // åˆ›å»ºä¸€ä¸ªä¸´æ—¶æ‹·è´çš„æ–‡ä»¶åå­—ç¬¦ä¸²
      char *token, *temp_ptr;
      char *filename_cp = malloc(strlen(file_name) + 1);
      strlcpy (filename_cp, file_name, strlen(file_name) + 1);
    
      // è®¡ç®—å‚æ•°æ•°é‡ (argc)
      enum intr_level old_level = intr_disable();
      int argc = 1; // åˆå§‹å€¼ä¸º 1ï¼Œå› ä¸ºè‡³å°‘æœ‰ä¸€ä¸ªå‚æ•°
      bool is_lastone_space = false; // è®°å½•æœ€åä¸€ä¸ªå­—ç¬¦æ˜¯å¦ä¸ºç©ºæ ¼
      for (int j = 0; j != strlen(file_name); j++) {
        if (file_name[j] == ' ') {
          if (!is_lastone_space)
            argc++; // å¦‚æœé‡åˆ°æ–°çš„ç©ºæ ¼ä¸”ä¸æ˜¯è¿ç»­ç©ºæ ¼ï¼Œå‚æ•°è®¡æ•°åŠ ä¸€
          is_lastone_space = true;
        } else {
          is_lastone_space = false;
        }
      }
      intr_set_level (old_level);
    
      // ä¸ºå‚æ•°æŒ‡é’ˆ (argv) åˆ†é…å†…å­˜
      int *argv = calloc(argc, sizeof(int));
    
      // å°†æ–‡ä»¶ååˆ†å‰²ä¸ºå„ä¸ªå‚æ•°ï¼Œå¹¶ä¾æ¬¡å‹å…¥æ ˆä¸­
      int i;
      token = strtok_r (file_name, " ", &temp_ptr);
      for (i = 0; ; i++) {
        if (token) {
          *esp -= strlen(token) + 1; // ä¸ºå‚æ•°å­—ç¬¦ä¸²åˆ†é…ç©ºé—´
          memcpy(*esp, token, strlen(token) + 1); // å°†å‚æ•°å­—ç¬¦ä¸²å¤åˆ¶åˆ°æ ˆ
          argv[i] = *esp; // ä¿å­˜å‚æ•°åœ°å€
          token = strtok_r (NULL, " ", &temp_ptr); // è·å–ä¸‹ä¸€ä¸ªå‚æ•°
        } else {
          break; // æ²¡æœ‰æ›´å¤šå‚æ•°æ—¶é€€å‡ºå¾ªç¯
        }
      }
    
      // å¯¹é½åˆ° 4 å­—èŠ‚è¾¹ç•Œ (Word Align)
      *esp -= ((unsigned)*esp % 4);
    
      // ç©ºæŒ‡é’ˆæ ‡å¿— (null pointer sentinel)ï¼Œè¡¨ç¤º argv[argc] ä¸ºç©º
      *esp -= sizeof(int);
    
      // å°†å‚æ•°åœ°å€ä¾æ¬¡å‹å…¥æ ˆä¸­
      for (i = argc - 1; i >= 0; i--)
      {
        *esp -= sizeof(int);
        memcpy(*esp, &argv[i], sizeof(int));
      }
    
      // å‹å…¥ argv çš„åœ°å€
      int tmp = *esp;
      *esp -= sizeof(int);
      memcpy(*esp, &tmp, sizeof(int));
    
      // å‹å…¥ argc (å‚æ•°æ•°é‡)
      *esp -= sizeof(int);
      memcpy(*esp, &argc, sizeof(int));
    
      // å‹å…¥è¿”å›åœ°å€ (return address)
      *esp -= sizeof(int);
      memcpy(*esp, &argv[argc], sizeof(int));
    
      // æ‰“å°æ ˆçš„çŠ¶æ€ï¼Œä¾¿äºè°ƒè¯•
      printf("STACK SET. ESP: %p\n", esp);
      hex_dump((uintptr_t)esp, esp, 100, true); // æ‰“å°æ ˆä¸­å‰ 100 å­—èŠ‚çš„æ•°æ®ï¼Œä¾¿äºè°ƒè¯•
    
      // é‡Šæ”¾ä¸´æ—¶åˆ†é…çš„å†…å­˜
      free(filename_cp);
      free(argv);
    
      return success;
    }
    
\end{lstlisting}

\begin{ctt}
    åœ¨å®˜æ–¹æ–‡æ¡£ä¸­æåˆ°ï¼Œæ ˆçš„å¢é•¿æ˜¯åæ–¹å‘çš„ï¼šæ ˆåœ°å€æ˜¯å‘ä¸‹å¢é•¿çš„ï¼Œè€Œå­—ç¬¦ä¸²çš„åœ°å€æ˜¯å‘ä¸Šå¢é•¿çš„ï¼Œæ‰€ä»¥åœ¨æ”¾
    ç½®å‚æ•°çš„æ—¶å€™éœ€è¦æŠŠå‚æ•°å€’åºæ”¾ç½®ã€‚
\end{ctt}

ç›´åˆ°è¿™é‡Œï¼Œå³ä½¿æˆ‘ä»¬ä½¿ç”¨ \textbf{make check} å‘½ä»¤ï¼Œä»ç„¶æ— æ³•çœ‹åˆ°è¾“å‡ºï¼Œåªä¼šå‡ºç°ï¼š

\begin{mdframed}
    Run didnâ€™t produce any outputâ€ã€‚
\end{mdframed}

å› ä¸ºç”¨æˆ·ç¨‹åºçš„æ‰“å°ï¼ˆè¾“å‡ºåˆ° stdoutï¼‰ä¹Ÿæ˜¯é€šè¿‡å†™çš„ç³»ç»Ÿè°ƒç”¨å®ç°çš„ã€‚

\begin{figure}[H]
    \centering
    \includegraphics[width=0.5\textwidth]{img5/write.png}
    \caption{write()}
    \label{fig:fail}
\end{figure}

\subsection{å®ç°ç³»ç»Ÿè°ƒç”¨}

é™¤äº†æˆ‘ä»¬è¦å®ç°çš„ \texttt{userprog/syscall.c}ï¼Œåœ¨ \texttt{lib/user} æ–‡ä»¶å¤¹ä¸‹ï¼Œè¿˜æœ‰ä¸€å¯¹ \texttt{syscall.h} å’Œ \texttt{syscall.c} æ–‡ä»¶

\begin{ctt}
è¿™ç»„æ–‡ä»¶ï¼Œæ˜¯ æä¾›ç»™ç”¨æˆ·çš„ç³»ç»Ÿè°ƒç”¨æ¥å£ï¼Œå…¶é€šè¿‡ int \$0x30 
ä¸­æ–­æŒ‡ä»¤ä»¥å”¤èµ·ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œ
æœ€ç»ˆä¼šè½å…¥ userprog/syscall.c çš„ syscall\_handler() å‡½æ•°ä¸­ã€‚
\end{ctt}

å…¶ enum ä¸­å®šä¹‰äº†ä¸åŒçš„ç³»ç»Ÿè°ƒç”¨çš„åºå·ï¼š

\begin{lstlisting}[language=C, title= syscall.h]
    enum {
        /* Projects 2 and later. */
        SYS_HALT,                   /**< Halt the operating system. */
        SYS_EXIT,                   /**< Terminate this process. */
        SYS_EXEC,                   /**< Start another process. */
        SYS_WAIT,                   /**< Wait for a child process to die. */
        SYS_CREATE,                 /**< Create a file. */
        SYS_REMOVE,                 /**< Delete a file. */
        SYS_OPEN,                   /**< Open a file. */
        SYS_FILESIZE,               /**< Obtain a file's size. */
        SYS_READ,                   /**< Read from a file. */
        SYS_WRITE,                  /**< Write to a file. */
        SYS_SEEK,                   /**< Change position in a file. */
        SYS_TELL,                   /**< Report current position in a file. */
        SYS_CLOSE,                  /**< Close a file. */
    
        /* Project 3 and optionally project 4. */
        SYS_MMAP,                   /**< Map a file into memory. */
        SYS_MUNMAP,                 /**< Remove a memory mapping. */
    
        /* Project 4 only. */
        SYS_CHDIR,                  /**< Change the current directory. */
        SYS_MKDIR,                  /**< Create a directory. */
        SYS_READDIR,                /**< Reads a directory entry. */
        SYS_ISDIR,                  /**< Tests if a fd represents a directory. */
        SYS_INUMBER                 /**< Returns the inode number for a fd. */
      };
\end{lstlisting}

æ•…æˆ‘ä»¬éœ€è¦åœ¨ \textbf{syscall\_handler()} ä¸­å®ç°åˆ†å‘ï¼š
æ ¹æ®ç±»å‹åˆ†å‘ç»™å„ä¸ªå…·ä½“å¤„ç†å‡½æ•°ï¼Œé€ä¸ªå®ç°ã€‚
è¿”å›å€¼è¦æ”¾åœ¨ EAX ä¸­ä¼ å›è°ƒç”¨è€…ã€‚

\begin{ctt}
    åœ¨ Pintos ä¸­ï¼Œstruct intr\_frame æ˜¯ç”¨æ¥ä¿å­˜ä¸­æ–­å¤„ç†å™¨çŠ¶æ€çš„ç»“æ„ä½“ã€‚åœ¨ç³»ç»Ÿè°ƒç”¨è¿”å›æ—¶ï¼Œé€šå¸¸ä¼šå°†ç»“æœå€¼å­˜å‚¨åˆ° f->eax ä¸­ï¼Œå› ä¸ºè¿™æ˜¯ x86 æ¶æ„çš„çº¦å®šâ€”â€”è¿”å›å€¼é€šè¿‡ eax å¯„å­˜å™¨ä¼ é€’ã€‚
    
    \vspace{0.5cm}

    å¯¹äºç³»ç»Ÿè°ƒç”¨ SYS\_EXITï¼Œéœ€è¦è¿”å›ä¸€ä¸ªé€€å‡ºç åˆ°ç”¨æˆ·è¿›ç¨‹ï¼Œè¿”å›å€¼å°±éœ€è¦å­˜æ”¾åˆ° f->eax ä¸­ã€‚
    ç±»ä¼¼åœ°ï¼ŒSYS\_WRITE ä¹Ÿä¼šå°†å†™å…¥çš„å­—èŠ‚æ•°è¿”å›åˆ° f->eaxã€‚
\end{ctt}

\begin{lstlisting}[language=C, title= syscall.c]
    static void syscall_handler (struct intr_frame *f UNUSED) {
        int *p = f->esp;
        is_valid_addr(p);
    
        int system_call = *p;
        switch (system_call) {
            case SYS_HALT: syscall_halt(); break;
            case SYS_EXIT: syscall_exit(f); break; // ç›´æ¥å…³æœºï¼Œä¸éœ€è¦è¿”å›å€¼ï¼Œæ•…æ˜¯ void function
            case SYS_EXEC: f->eax = syscall_exec(f); break;
            case SYS_WAIT: f->eax = syscall_wait(f); break;
            case SYS_CREATE: f->eax = syscall_creat(f); break;
            case SYS_REMOVE: f->eax = syscall_remove(f); break;
            case SYS_OPEN: f->eax = syscall_open(f); break;
            case SYS_FILESIZE: f->eax = syscall_filesize(f); break;
            case SYS_READ: f->eax = syscall_read(f); break;
            case SYS_WRITE: f->eax = syscall_write(f); break;
            case SYS_SEEK: syscall_seek(f); break; // è°ƒæ•´æ–‡ä»¶æŒ‡é’ˆçš„ä½ç½®ï¼Œä¹Ÿä¸éœ€è¦è¿”å›å€¼
            case SYS_TELL: f->eax = syscall_tell(f); break;
            case SYS_CLOSE: syscall_close(f); break;
    
            default:
            printf("Default %d\n",*p);
        }
    }
\end{lstlisting}

åœ¨ä¸Šæ–¹çš„å‡½æ•°ä¸­ï¼Œæœ‰ä¸€äº›å‡½æ•°æ˜¯ä¸éœ€è¦è¿”å›å€¼çš„ï¼Œè¿™äº› \texttt{void function} åœ¨å®šä¹‰çš„æ—¶å€™è¦æ³¨æ„ä¸€ä¸‹ã€‚

å…¶æ¬¡ï¼ŒPintos ä¸­å·²ç»ä½¿ç”¨äº† \texttt{syscall\_init} å°†ä¸­æ–­å¤„ç†å‡½æ•°æ³¨å†Œåˆ°å¯„å­˜å™¨ï¼š

\begin{lstlisting}[language=C, title= init.c]
    void syscall_init (void) {
        intr_register_int (0x30, 3, INTR_ON, syscall_handler, "syscall");
    }
\end{lstlisting}

å¦å¤–è¦æ³¨æ„çš„æ˜¯ï¼ŒPintos ä¸­ä¸å…è®¸åœ¨ç³»ç»Ÿè°ƒç”¨ä¸­ä½¿ç”¨ malloc() å‡½æ•°ï¼š

\begin{figure}[H]
    \centering
    \includegraphics[width=0.5\textwidth]{img5/warning.png}
    \caption{malloc()}
    \label{fig:malloc}
    \end{figure}
\subsection{å¤„ç†å†…å­˜éæ³•è®¿é—®}

PPT ä¸­çš„æç¤ºäº†ä½¿ç”¨ \textbf{syscall\_create} æ¥å®ç°ï¼š

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{img5/ppt.png}
    \caption{PPT}
    \label{fig:check}
\end{figure}

ä¸ºäº†ä¿è¯å†…æ ¸ä¸å—åˆ°ç ´åï¼Œéœ€è¦ç«‹å³ç»ˆæ­¢å‘å‡ºéæ³•æŒ‡é’ˆè¯·æ±‚çš„è¿›ç¨‹ã€‚æŸ¥
çœ‹ \texttt{userprog/pagedir.c} å’Œ \texttt{threads/vaddr.h}ï¼Œå¯ä»¥å‘ç°å·²ç»ä¸ºæˆ‘ä»¬å®šä¹‰äº†ä»¥ä¸‹ä¸¤ä¸ªå‡½æ•°:

\begin{lstlisting}[language=C,title= pagedir\_get\_page()]
    /* Looks up the physical address that corresponds to user virtual address UADDR in PD.
    Returns the kernel virtual address
    corresponding to that physical address, or a null pointer if UADDR is unmapped. */
    void *pagedir_get_page (uint32_t *pd, const void *uaddr) {
    uint32_t *pte;
    ASSERT (is_user_vaddr (uaddr));
    pte = lookup_page (pd, uaddr, false);
    if (pte != NULL && (*pte & PTE_P) != 0)
        return pte_get_page (*pte) + pg_ofs (uaddr);
    else
        return NULL;
   }
\end{lstlisting}

\begin{lstlisting}[language=C,title= is\_user\_vaddr()]
    /* Returns true if VADDR is a user virtual address. */
    static inline bool is_user_vaddr (const void *vaddr) {
        return vaddr < PHYS_BASE;
    }
\end{lstlisting}

é™¤äº†ç©ºæŒ‡é’ˆä»¥å¤–ï¼Œè¿™å°±æ˜¯æœ€å¸¸è§çš„ä¸¤ä¸ªå¼‚å¸¸æƒ…å†µã€‚å½“å‡ºç°å¼‚å¸¸çš„æ—¶å€™éƒ½ä¼šè¿”å›å¼‚å¸¸ä¿¡æ¯ã€‚
å¯ä»¥å€ŸåŠ©è¿™ä¸¤ä¸ªå‡½æ•°æ¥å®ç°å†…å­˜è®¿é—®çš„å®‰å…¨æ§åˆ¶ã€‚

æˆ‘ä»¬å¯ä»¥è·Ÿç€è¿™ä¸ªæ€è·¯æ¥ç¼–å†™ä»£ç ï¼š

\begin{lstlisting}[language=C, title= syscall\_create()]
    // æ£€æŸ¥ä¼ å…¥çš„è™šæ‹Ÿåœ°å€æ˜¯å¦æ˜¯ç”¨æˆ·ç©ºé—´çš„æœ‰æ•ˆåœ°å€ï¼š
    // ä½¿ç”¨ is_user_vaddr åˆ¤æ–­åœ°å€æ˜¯å¦åœ¨ç”¨æˆ·åœ°å€èŒƒå›´å†…ã€‚å¦‚æœæ˜¯æœ‰æ•ˆçš„ç”¨æˆ·åœ°å€ï¼Œåˆ™ä½¿ç”¨ pagedir_get_page ä»å½“å‰çº¿ç¨‹çš„é¡µç›®å½•ä¸­è·å–è¯¥è™šæ‹Ÿåœ°å€å¯¹åº”çš„ç‰©ç†é¡µæŒ‡é’ˆã€‚
    // å¦‚æœåœ°å€æ— æ•ˆæˆ–æ— æ³•æ‰¾åˆ°å¯¹åº”çš„ç‰©ç†é¡µï¼Œåˆ™è°ƒç”¨ exit_process(-1) é€€å‡ºå½“å‰è¿›ç¨‹ã€‚

    void *is_valid_addr(const void *vaddr) {
        void *page_ptr = NULL;
        if (!is_user_vaddr(vaddr) || !(page_ptr = pagedir_get_page(thread_current()->pagedir, vaddr))) {
            // åœ°å€æ— æ•ˆï¼Œé€€å‡ºè¿›ç¨‹
            exit_process(-1);
            return 0;
        }
    // åœ°å€æœ‰æ•ˆï¼Œè¿”å›ç‰©ç†é¡µæŒ‡é’ˆ
    return page_ptr;
    }
\end{lstlisting}

å¦‚æœåœ°å€æ— æ•ˆåˆ™ä»¥å¼‚å¸¸çŠ¶æ€ä¸­æ­¢è¿›ç¨‹ï¼Œæœ‰æ•ˆåˆ™è¿”å›ç‰©ç†åœ°å€ã€‚

å†ç¼–å†™ pop\_stack() å‡½æ•°ï¼Œç”¨äºä»æ ˆä¸­å–å¾—å…ƒç´ ï¼Œæ–¹ä¾¿å–å¾—å‚æ•°ï¼š

\begin{lstlisting}[language=C, title= pop\_stack()]
    void pop_stack(int *esp, int *a, int offset){
        int *tmp_esp = esp;
        *a = *((int *)is_valid_addr(tmp_esp + offset));
    }
\end{lstlisting}

è¿™é‡Œæ˜¯å› ä¸º Pintos ä½¿ç”¨çš„æ˜¯ 4 å­—èŠ‚å¯¹é½ï¼Œæ‰€ä»¥ offset å‚æ•°å¯ä»¥æ–¹ä¾¿åœ°ä½¿ç”¨æ•´æ•°æ¥å–å¾—å‚æ•°ã€‚

\begin{figure}[H]
    \centering
    \includegraphics[width=0.5\textwidth]{img5/stackpointer.png}
    \caption{æ ˆæŒ‡é’ˆ}
    \label{fig:stack}
\end{figure}

\subsection{å®Œå–„ç³»ç»Ÿè°ƒç”¨}

æŒ‰ç…§ PPT è¦æ±‚ï¼Œåœ¨ \texttt{thread.h} ä¸­æ–°å¢ç»“æ„ä½“å˜é‡ï¼š

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{img5/new.png}
    \caption{thread.h}
    \label{fig:thread}
\end{figure}

åŒæ—¶å®šä¹‰å…¨å±€é”ï¼š\textbf{struct lock filesys\_lock}ï¼Œç”¨äºæ–‡ä»¶ç³»ç»Ÿæ“ä½œçš„åŒæ­¥ã€‚è¯¥ç»“æ„ä½“ \texttt{lock} ä½äº \textbf{synch.h} ä¸­ã€‚

å½“ç„¶ï¼Œä¸èƒ½å¿˜è®°äº†å­è¿›ç¨‹çš„ç»“æ„ä½“å®šä¹‰ï¼š

\begin{lstlisting}[language=C,title= child\_process]
struct child_process {
    int tid;                     /**< å­è¿›ç¨‹çš„çº¿ç¨‹ IDã€‚ */
    bool if_waited;              /**< å­è¿›ç¨‹æ˜¯å¦å·²è¢«çˆ¶è¿›ç¨‹ç­‰å¾…ã€‚ */
    int exit_status;             /**< å­è¿›ç¨‹çš„é€€å‡ºçŠ¶æ€ã€‚ */
    struct list_elem child_elem; /**< å­è¿›ç¨‹çš„å…ƒç´ ã€‚ */
    struct semaphore wait_sema;  /**< ç­‰å¾…å­è¿›ç¨‹é€€å‡ºçš„ä¿¡å·é‡ã€‚ */
};
\end{lstlisting}

\subsubsection{halt}

è¿™é‡Œåªéœ€è¦ç®€å•åœ°è°ƒç”¨ \textbf{devices/shutdown.c} ä¸‹çš„å‡½æ•°æ¥å£å³å¯ï¼š

\begin{lstlisting}[language=C]
    void syscall_halt(void){
        shutdown_power_off();
    }
\end{lstlisting}

\subsection{syscall\_exit}

\begin{lstlisting} [language=C]
static void syscall_exit(struct intr_frame *f) {
    // exit_codeåœ¨ç³»ç»Ÿè°ƒç”¨ä¹‹åè¢«è§£æä¸ºå‚æ•°
    int exit_code = *(int *)check_read_user_ptr(f->esp + ptr_size, sizeof(int));
    thread_current()->exit_status = exit_code;
    thread_exit();
}
\end{lstlisting}

\vspace{0.8cm}

\begin{ctt}
\texttt{syscall\_exit} å‡½æ•°å®ç°äº†ç³»ç»Ÿè°ƒç”¨ï¼Œç”¨äºç»ˆæ­¢å½“å‰è¿›ç¨‹ã€‚
é€šè¿‡éå†æŸ¥æ‰¾å¯¹åº”çš„å­è¿›ç¨‹æè¿°ç»“æ„ï¼ˆ\texttt{child\_process}ï¼‰ï¼Œ
æ›´æ–°å…¶é€€å‡ºçŠ¶æ€ç ï¼ˆ\texttt{exit\_status}ï¼‰ä»¥åŠæ˜¯å¦å·²è¢«çˆ¶çº¿ç¨‹ç­‰å¾…çš„æ ‡å¿—ï¼ˆ\texttt{if\_waited}ï¼‰ã€‚
åŒæ—¶ï¼Œå°†å½“å‰çº¿ç¨‹çš„é€€å‡ºçŠ¶æ€å­˜å‚¨åœ¨å…¶è‡ªèº«çš„ \texttt{exit\_status} å­—æ®µä¸­ã€‚
ä¸ºäº†é¿å…å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„ç«äº‰é—®é¢˜ï¼Œå‡½æ•°é€šè¿‡ç¦ç”¨ä¸­æ–­ï¼ˆ\texttt{intr\_disable}ï¼‰ç¡®ä¿çŠ¶æ€æ›´æ–°çš„åŸå­æ€§ã€‚

\vspace{0.5cm}

æœ€åè°ƒç”¨ \texttt{thread\_exit} ç»ˆæ­¢å½“å‰çº¿ç¨‹ï¼Œä¹‹æ‰€ä»¥é€‰æ‹© \texttt{thread\_exit} è€Œéç›´æ¥è°ƒç”¨ \texttt{process\_exit}ï¼Œ
æ˜¯å› ä¸ºå‰è€…è¿˜åŒ…å«äº†å¯¹ä¿¡å·é‡çš„åŒæ­¥æ“ä½œï¼Œå¹¶ä¸”å¯ä»¥ç”¨äºç»ˆæ­¢ç”¨æˆ·è¿›ç¨‹å’Œç³»ç»Ÿçº¿ç¨‹ã€‚
\end{ctt}

\vspace{0.8cm}

å…¶ä¸­ï¼Œå­å‡½æ•° \texttt{exit\_process} çš„å®ç°å¦‚ä¸‹ï¼š

\begin{lstlisting}[language=C]
    void exit_process(int status) {
        struct child_process *cp;
        struct thread *cur_thread = thread_current();
        enum intr_level old_level = intr_disable(); // ç¦ç”¨ä¸­æ–­ä»¥ä¿è¯çº¿ç¨‹çŠ¶æ€æ›´æ–°çš„å®‰å…¨æ€§ã€‚
    
        // éå†å½“å‰çº¿ç¨‹çš„çˆ¶çº¿ç¨‹çš„å­çº¿ç¨‹åˆ—è¡¨ï¼Œæ›´æ–°å½“å‰çº¿ç¨‹åœ¨çˆ¶çº¿ç¨‹è®°å½•ä¸­çš„çŠ¶æ€ã€‚
        for (struct list_elem *e = list_begin(&cur_thread->parent->children_list);
             e != list_end(&cur_thread->parent->children_list);
             e = list_next(e)) {
            cp = list_entry(e, struct child_process, child_elem);
            if (cp->tid == cur_thread->tid) {
                cp->if_waited = true;       // æ ‡è®°å½“å‰çº¿ç¨‹å·²è¢«çˆ¶çº¿ç¨‹ç­‰å¾…è¿‡ã€‚
                cp->exit_status = status;  // æ›´æ–°é€€å‡ºçŠ¶æ€ã€‚
            }
        }
        cur_thread->exit_status = status;  // è®¾ç½®å½“å‰çº¿ç¨‹çš„é€€å‡ºçŠ¶æ€ã€‚
        intr_set_level(old_level); // æ¢å¤ä¸­æ–­çŠ¶æ€
        thread_exit(); // é€€å‡ºå½“å‰çº¿ç¨‹
    }
\end{lstlisting}

\subsection{syscall\_exec}

\begin{lstlisting}[language=C]
    // è¿è¡Œå…¶åç§°åœ¨ cmd_line ä¸­ç»™å‡ºçš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¹¶ä¼ é€’ä»»ä½•ç»™å®šçš„å‚æ•°ï¼Œè¿”å›æ–°è¿›ç¨‹çš„è¿›ç¨‹ID(pid)
    static void syscall_exec(struct intr_frame *f) {
        char *cmd_line = *(char **)check_read_user_ptr(f->esp + ptr_size, ptr_size);
        check_read_user_str(cmd_line);
        f->eax = process_execute(cmd_line);
    }
\end{lstlisting}

\vspace{0.7cm}

\begin{ctt}
    \texttt{syscall\_exec} å‡½æ•°å®ç°äº† exec ç³»ç»Ÿè°ƒç”¨ï¼Œ
    ç”¨äºè¿è¡Œç”¨æˆ·ç¨‹åºæŒ‡å®šçš„å¯æ‰§è¡Œæ–‡ä»¶å¹¶ä¼ é€’å‘½ä»¤è¡Œå‚æ•°ã€‚
    å‡½æ•°é¦–å…ˆä»ç”¨æˆ·æ ˆä¸­è¯»å–å‘½ä»¤è¡Œå­—ç¬¦ä¸²ï¼ˆ\texttt{cmd\_line}ï¼‰ï¼Œè¿™æ˜¯ç”¨æˆ·ç¨‹åºä¼ é€’çš„å‚æ•°ã€‚

    \vspace{0.4cm}

    éšåï¼Œé€šè¿‡ \texttt{check\_read\_user\_ptr}éªŒè¯å‘½ä»¤è¡ŒæŒ‡é’ˆæ˜¯å¦åˆæ³•ï¼Œ
    ç¡®ä¿æŒ‡é’ˆæŒ‡å‘çš„åœ°å€ä½äºç”¨æˆ·ç©ºé—´å†…ï¼Œ
    å¹¶è¿›ä¸€æ­¥ä½¿ç”¨ \texttt{check\_read\_user\_str} éªŒè¯å­—ç¬¦ä¸²çš„å†…å®¹æ˜¯å¦å®‰å…¨å¯è¯»ï¼Œé˜²æ­¢éæ³•å†…å­˜è®¿é—®ã€‚
    éªŒè¯é€šè¿‡åï¼Œå‡½æ•°è°ƒç”¨ \texttt{process\_execute}(\texttt{cmd\_line})ï¼Œ
    ç”¨äºåˆ›å»ºæ–°è¿›ç¨‹å¹¶æ‰§è¡Œå‘½ä»¤è¡Œä¸­æŒ‡å®šçš„ç¨‹åºã€‚\texttt{process\_execute} è¿”å›æ–°è¿›ç¨‹çš„è¿›ç¨‹ IDï¼ˆpidï¼‰ï¼Œ
    ä»£è¡¨å­è¿›ç¨‹çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œå‡½æ•°å°†å…¶å­˜å‚¨åœ¨ä¸­æ–­å¸§çš„ eax å¯„å­˜å™¨ä¸­ï¼Œä¾›ç”¨æˆ·ç¨‹åºè®¿é—®ã€‚
\end{ctt}

\subsection{syscall\_wait}

\begin{lstlisting}[language=C, title= syscall\_wait()]
    int syscall_wait(struct intr_frame *f) {
        tid_t child_tid;
        pop_stack(f->esp, &child_tid, 1);  // Extract the child process ID from the user stack.
        return process_wait(child_tid);   // Wait for the child process and return its exit status.
    }
\end{lstlisting}

\begin{ctt}
    \texttt{syscall\_wait} å®ç°äº† WAIT ç³»ç»Ÿè°ƒç”¨ï¼Œç”¨äºå½“å‰è¿›ç¨‹ç­‰å¾…ä¸€ä¸ªæŒ‡å®šçš„å­è¿›ç¨‹å®Œæˆæ‰§è¡Œã€‚å®ƒé€šè¿‡ä¸­æ–­å¸§çš„æ ˆæŒ‡é’ˆï¼ˆf->espï¼‰ä»ç”¨æˆ·æ ˆä¸­è·å–ä¼ é€’çš„å­è¿›ç¨‹çº¿ç¨‹ IDï¼ˆtidï¼‰ã€‚
\end{ctt}



åœ¨æœªå®ç° \texttt{syscall\_write} ä¹‹å‰ï¼Œä¼šå‡ºç°è¿™æ ·çš„æƒ…å†µï¼š

\begin{figure}[H]
    \centering
    \begin{subfigure}[b]{0.45\textwidth}
        \centering
        \includegraphics[width=\textwidth]{img5/failed1.png}
        \label{fig:failed1}
    \end{subfigure}
    \hfill
    \begin{subfigure}[b]{0.45\textwidth}
        \centering
        \includegraphics[width=\textwidth]{img5/failed2.png}
        \label{fig:failed2}
    \end{subfigure}
    \caption{Combination of Failed Results}
    \label{fig:failed_results}
\end{figure}


è¾“å‡ºçš„ç»“æœæ˜¾ç¤ºä¸ºï¼š\textbf{Default 9} è¿™åœ¨ \texttt{user/syscall.c} ä¸­æ˜¯ 9 å·ï¼Œ \texttt{SYS\_WRITE}ï¼Œç”¨æˆ·ç¨‹åºçš„æ‰“å°ï¼ˆè¾“å‡ºåˆ° stdoutï¼‰ä¹Ÿæ˜¯é€šè¿‡å†™çš„ç³»ç»Ÿè°ƒç”¨å®ç°çš„ã€‚

\subsubsection{syscall\_write}

\begin{lstlisting}[language=C, title= syscall\_write()]
    int syscall_write(struct intr_frame *f) {
        int ret;                  /**< å†™å…¥æ“ä½œçš„è¿”å›å€¼ã€‚ */
        int size;                 /**< è¦å†™å…¥çš„æ•°æ®å¤§å°ï¼ˆå­—èŠ‚ï¼‰ã€‚ */
        void *buffer;             /**< æ•°æ®ç¼“å†²åŒºçš„èµ·å§‹åœ°å€ã€‚ */
        int fd;                   /**< æ–‡ä»¶æè¿°ç¬¦ã€‚ */
    
        // ä»ç”¨æˆ·æ ˆä¸­è¯»å–ç³»ç»Ÿè°ƒç”¨å‚æ•°ï¼Œåˆ†åˆ«æ˜¯ sizeã€buffer å’Œ fd
        pop_stack(f->esp, &size, 7);
        pop_stack(f->esp, &buffer, 6);
        pop_stack(f->esp, &fd, 5);
    
        // æ£€æŸ¥ buffer æ˜¯å¦ä¸ºæœ‰æ•ˆçš„ç”¨æˆ·åœ°å€
        if (!is_valid_addr(buffer))
            ret = -1;

        // å¦‚æœæ–‡ä»¶æè¿°ç¬¦æ˜¯æ ‡å‡†è¾“å‡ºï¼ˆfd == 1ï¼‰ï¼Œç›´æ¥å°†æ•°æ®è¾“å‡ºåˆ°æ§åˆ¶å°
        if (fd == 1) {
            putbuf(buffer, size); /**< è°ƒç”¨ç³»ç»Ÿæä¾›çš„ putbuf() å‡½æ•°å†™å…¥æ§åˆ¶å°ã€‚ */
            ret = size;           /**< è¿”å›å†™å…¥çš„å­—èŠ‚æ•°ï¼Œå³ sizeã€‚ */
        } else {
            // æ–‡ä»¶å†™å…¥æ“ä½œï¼Œéœ€è¦æŸ¥æ‰¾æ–‡ä»¶æè¿°ç¬¦å¯¹åº”çš„æ–‡ä»¶æŒ‡é’ˆ
            enum intr_level old_level = intr_disable(); /**< ç¦ç”¨ä¸­æ–­ï¼Œé¿å…å¤šçº¿ç¨‹ç«äº‰ã€‚ */
            struct process_file *pf = search_fd(&thread_current()->opened_files, fd);
            intr_set_level(old_level); /**< æ¢å¤ä¸­æ–­çŠ¶æ€ã€‚ */
            // å¦‚æœæ–‡ä»¶æè¿°ç¬¦æ— æ•ˆï¼Œè¿”å›é”™è¯¯
            if (pf == NULL) ret = -1;
            else {
                // è·å–æ–‡ä»¶ç³»ç»Ÿé”ï¼Œç¡®ä¿æ–‡ä»¶å†™æ“ä½œæ˜¯çº¿ç¨‹å®‰å…¨çš„
                lock_acquire(&filesys_lock);
                ret = file_write(pf->ptr, buffer, size); /**< å†™å…¥æ•°æ®åˆ°æ–‡ä»¶ï¼Œè¿”å›å†™å…¥å­—èŠ‚æ•°ã€‚ */
                lock_release(&filesys_lock);
            }
        }
        return ret;
    }
\end{lstlisting}

\begin{ctt}
syscall\_write å‡½æ•°å®ç°äº†ç³»ç»Ÿè°ƒç”¨ï¼Œç”¨äºå‘æ–‡ä»¶æˆ–æ ‡å‡†è¾“å‡ºå†™å…¥æ•°æ®ã€‚
å‡½æ•°é¦–å…ˆé€šè¿‡ä»ç”¨æˆ·æ ˆä¸­è¯»å–å‚æ•°ï¼ˆsizeã€bufferã€fdï¼‰å®Œæˆå‚æ•°ä¼ é€’ï¼Œç¡®ä¿ç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„éš”ç¦»ã€‚
éšåï¼Œæ£€æŸ¥ç¼“å†²åŒºåœ°å€æ˜¯å¦ä¸ºæœ‰æ•ˆçš„ç”¨æˆ·åœ°å€ï¼Œä»¥é˜²æ­¢éæ³•å†…å­˜è®¿é—®ï¼Œä¿æŠ¤æ“ä½œç³»ç»Ÿçš„å®‰å…¨æ€§ã€‚
å¦‚æœæ–‡ä»¶æè¿°ç¬¦ä¸ºæ ‡å‡†è¾“å‡ºï¼ˆfd == 1ï¼‰ï¼Œç›´æ¥è°ƒç”¨ putbuf å°†æ•°æ®è¾“å‡ºåˆ°æ§åˆ¶å°ï¼Œç»•è¿‡æ–‡ä»¶ç³»ç»Ÿä»¥æé«˜æ•ˆç‡ã€‚

\vspace{0.5cm}

å¯¹äºå…¶ä»–æ–‡ä»¶æè¿°ç¬¦ï¼Œå‡½æ•°é€šè¿‡ç¦ç”¨ä¸­æ–­å’Œæ–‡ä»¶ç³»ç»Ÿé”ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œ
æŸ¥è¯¢æ–‡ä»¶æè¿°ç¬¦å¯¹åº”çš„æ–‡ä»¶æŒ‡é’ˆå¹¶æ‰§è¡Œæ–‡ä»¶å†™å…¥æ“ä½œï¼ŒåŒæ—¶ç¡®ä¿å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„èµ„æºç®¡ç†ã€‚
\end{ctt}

\section{å®éªŒç»“æœ}

\begin{rmr}

ä½¿ç”¨ \texttt{make check} å‘½ä»¤æ—¶ï¼Œä½†æ­¤æ—¶ä»ç„¶æ˜¾ç¤ºï¼šRun didnâ€™t produce any output.

æŸ¥è¯¢èµ„æ–™åæ˜¾ç¤ºï¼Œè¿™æ˜¯å› ä¸ºæ®‹ç•™çš„ \texttt{process\_wait} æœªå®ç°å¯¼è‡´ç”¨æˆ·ç¨‹åºè¿˜æ²¡æ‰§è¡Œæ•´ä¸ªç³»ç»Ÿå°±å…³æœºäº†ã€‚

\href{https://blog.csdn.net/Altair_alpha/article/details/126819252}{\underline{https://blog.csdn.net/Altair\_alpha/article/details/126819252}}

\end{rmr}

æ ¹æ®åšä¸»å†™çš„å½©è›‹çš„å†…å®¹ä½œå‡ºç›¸åº”çš„ä¿®æ”¹ï¼Œé‡æ–° makeï¼Œå¯ä»¥çœ‹åˆ°æ­¤æ—¶å·²ç»èƒ½å¤ŸæˆåŠŸé€šè¿‡å‚æ•°ä¼ é€’çš„äº”ä¸ªæµ‹è¯•ç‚¹ã€‚

åœ¨ \texttt{thread.c} ä¸­æ·»åŠ ä»¥ä¸‹å‡½æ•°ï¼š

\begin{lstlisting}[language=C]
    int thread_dead(tid_t tid) {
      struct list_elem *e;
      for (e = list_begin (&all_list); e != list_end (&all_list); e = list_next (e)) {
        struct thread *t = list_entry (e, struct thread, allelem);
        if (t->tid == tid) return 0;
      }
      return 1;
    }
\end{lstlisting}

å°† \texttt{process\_wait} å‡½æ•°ä¿®æ”¹ä¸ºå¦‚ä¸‹æ‰€ç¤ºï¼š

\begin{ctt}
    ä¹‹å‰çš„é—®é¢˜æ˜¯ç³»ç»Ÿåœ¨ç”¨æˆ·ç¨‹åºæ‰§è¡Œå®Œæˆå‰å°±å…³é—­äº†ï¼Œå¯¼è‡´æ²¡æœ‰æœºä¼šè¾“å‡ºé¢„æœŸç»“æœã€‚

    \vspace{0.5cm}

    é€šè¿‡åœ¨ \texttt{process\_wait()} ä¸­æ·»åŠ ä¸€ä¸ªæ— é™å¾ªç¯ï¼Œ
    ä¸»çº¿ç¨‹å¯ä»¥æŒç»­ç­‰å¾…å­è¿›ç¨‹å®Œæˆã€‚
    è¿™æ ·ï¼Œç”¨æˆ·ç¨‹åºåœ¨ç³»ç»Ÿå…³é—­å‰è·å¾—äº†è¶³å¤Ÿçš„æ—¶é—´å®Œæˆæ‰§è¡Œï¼Œå¹¶è¾“å‡ºç»“æœã€‚
\end{ctt}

\begin{lstlisting}[language=C]
    int process_wait (tid_t child_tid) {
      while (1) {
        thread_yield();
        if (thread_dead(child_tid)) break;
      }
      return -1;
    }

    int thread_dead(tid_t tid) {
    struct list_elem *e;
    for (e = list_begin (&all_list); e != list_end (&all_list); e = list_next (e)) {
        struct thread *t = list_entry (e, struct thread, allelem);
        if (t->tid == tid) return 0;  // å¦‚æœæ‰¾åˆ°ç›®æ ‡çº¿ç¨‹ï¼Œè¿”å› 0ï¼ˆæœªæ­»äº¡ï¼‰
    }
    return 1;                         // å¦‚æœç›®æ ‡çº¿ç¨‹ä¸åœ¨ `all_list` ä¸­ï¼Œè¿”å› 1ï¼ˆå·²æ­»äº¡ï¼‰
}
\end{lstlisting}

\begin{itemize}
    \item \texttt{all\_list} æ˜¯æ‰€æœ‰çº¿ç¨‹çš„é“¾è¡¨ã€‚ä¸€ä¸ªçº¿ç¨‹åœ¨æ­»äº¡åä¼šä» \texttt{all\_list} ä¸­ç§»é™¤ã€‚
    \item å¦‚æœ \texttt{tid} æ‰¾ä¸åˆ°åŒ¹é…çš„çº¿ç¨‹ï¼Œåˆ™è®¤ä¸ºçº¿ç¨‹å·²ç»æ­»äº¡ã€‚
\end{itemize}

è¿è¡Œ \texttt{make clean å’Œ make check}

å¾—åˆ°ä»¥ä¸‹ç»“æœï¼š

\begin{figure}[H]
    \centering
    \includegraphics[width=0.9\textwidth]{img5/pass5.png}
    \caption{make check}
    \label{fig:check}
\end{figure}

ç­‰åˆ°ç¨‹åºæœ€ç»ˆè¿è¡Œå®Œæˆæ—¶ï¼Œå¯ä»¥çœ‹åˆ° 5 ä¸ªä¸å‚æ•°ä¼ é€’æœ‰å…³çš„æµ‹è¯•ç‚¹å‡å·²é€šè¿‡ã€‚

\begin{figure}[H]
    \centering
    \includegraphics[width=0.45\textwidth]{img5/pass.png}
    \caption{make check}
    \label{fig:check}
\end{figure}

\section{é™„å½•}

\subsection*{å‚è€ƒèµ„æ–™}

\begin{itemize}
    \item Pintos å•ä¸€æµ‹è¯•ç‚¹ä»£ç ï¼š\href{https://pastebin.com/tFRfywvv}{\underline{https://pastebin.com/tFRfywvv}}
    \item Pintos Lab2ï¼šç”¨æˆ·ç¨‹åº User Programsï¼ˆä¸Šï¼‰ï¼š\href{https://blog.csdn.net/Altair_alpha/article/details/126819252}{\underline{https://blog.csdn.net/Altair\_alpha/article/details/126819252}}
    \item Pintos æŒ‡å¯¼æ‰‹å†Œï¼š\href{https://pkuflyingpig.gitbook.io/pintos/project-description/lab2-user-programs/suggestions}{\underline{https://pkuflyingpig.gitbook.io/pintos/project-description/lab2-user-programs/suggestions}}
    \item OSå®éªŒï¼špintos project2ï¼š\href{https://zhuanlan.zhihu.com/p/382326973}{\underline{https://zhuanlan.zhihu.com/p/382326973}}
    \item æ–¯å¦ç¦å¤§å­¦Pintos Project1ã€2 æŒ‡å—+æ€»ç»“ï¼š\href{https://zhuanlan.zhihu.com/p/104497182}{\underline{https://zhuanlan.zhihu.com/p/104497182}}
\end{itemize}

\end{document}